<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FileHub - {{ owner_id }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/filehub.css') }}">
</head>
<body>
  <header>FileHub</header>

  <main class="fade-in">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Owner Storage Info -->
    {% if user.id == owner_id %}
    <div class="quota fade-in">
      <h3>Storage Usage</h3>
      <div class="progress-bar">
        <div class="progress-fill" style="width: {{ percent }}%;"></div>
      </div>
      <small>
        {{ (used / (1024*1024))|round(1) }} MB of 
        {{ (max_storage / (1024*1024))|round(1) }} MB used
      </small>
    </div>
    {% endif %}

    <!-- File List -->
    <h2>Files for {{ owner_id }}</h2>

    {% if files %}
      <ul class="file-list fade-in">
        {% for f in files %}
          <li class="file-item">
            <div class="file-info">
              <strong>{{ f.name }}</strong>
              <small>{{ (f.size / 1024)|round(1) }} KB • {{ f.modified }}</small>
            </div>
            <a href="{{ url_for('filehub.download', owner_id=owner_id, filename=f.name) }}" class="btn">Download</a>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="fade-in">No files uploaded yet.</p>
    {% endif %}

    <!-- Upload Section (Owner Only) -->
    {% if user.id == owner_id %}
    <section class="fade-in" style="margin-top:2rem;">
      <h3>Upload a File</h3>
      <form id="upload-form" method="post" enctype="multipart/form-data"
            action="{{ url_for('filehub.upload', owner_id=owner_id) }}">
        <input type="file" name="file" required>
        <button type="submit">Upload</button>
      </form>

      <div id="uploading" class="uploading">
        <p>Uploading...</p>
        <div class="upload-bar" id="upload-bar"></div>
      </div>

      <script>
        const form = document.getElementById('upload-form');
        const uploadBar = document.getElementById('upload-bar');
        const uploading = document.getElementById('uploading');

        form.addEventListener('submit', (e) => {
          e.preventDefault();
          const formData = new FormData(form);
          const xhr = new XMLHttpRequest();
          xhr.open('POST', form.action, true);

          xhr.upload.addEventListener('progress', (event) => {
            if (event.lengthComputable) {
              const percent = (event.loaded / event.total) * 100;
              uploadBar.style.width = percent + '%';
            }
          });

          xhr.onloadstart = () => {
            uploading.classList.add('active');
            uploadBar.style.width = '0%';
          };

          xhr.onloadend = () => {
            setTimeout(() => {
              location.reload();
            }, 800);
          };

          xhr.send(formData);
        });
      </script>
    </section>

    <!-- Access Management -->
    <section class="fade-in" style="margin-top:2rem;">
      <h3>Access Management</h3>

      <!-- Grant Access -->
      <form method="post" action="{{ url_for('filehub.grant_access', owner_id=owner_id) }}">
        <input type="text" name="discord_id" placeholder="Discord ID to grant access" required>
        <button type="submit">Grant</button>
      </form>

      <!-- List of Granted Users -->
      {% if access_list %}
        <ul class="file-list fade-in" style="margin-top:1rem;">
          {% for allowed in access_list %}
          <li class="file-item">
            <div class="file-info">
              <strong>{{ allowed }}</strong>
              <small>Has access</small>
            </div>
            <form method="post" action="{{ url_for('filehub.revoke_access', owner_id=owner_id) }}" style="margin:0;">
              <input type="hidden" name="discord_id" value="{{ allowed }}">
              <button type="submit" class="btn revoke">Revoke</button>
            </form>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p style="color:#94a3b8;margin-top:1rem;">No one else has access yet.</p>
      {% endif %}
    </section>
    {% endif %}
  </main>

  <footer>
    <p>© {{ datetime.utcnow().year }} FileHub • Secure Storage</p>
  </footer>
</body>
</html>
