<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wavebox ‚Ä¢ Developer Uploads</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dev_styles.css') }}">
  <style>
    .btn.accept {
      background: var(--accent, #1db954);
      color: white;
    }
    .btn.accept:hover {
      background: #1ed760;
    }
    .badge.accepted {
      background: var(--accent, #1db954);
      color: #fff;
    }
    .badge.pending {
      background: #888;
      color: #fff;
    }
    .badge.rejected {
      background: #b00020;
      color: #fff;
    }
    audio {
      width: 220px;
    }
    table tr.accepted {
      background: rgba(29, 185, 84, 0.08);
    }
    table tr.pending {
      background: rgba(255, 255, 255, 0.05);
    }
    table tr.rejected {
      background: rgba(176, 0, 32, 0.1);
    }
    footer {
      text-align: center;
      color: var(--muted, #aaa);
      margin-top: 40px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="dot"></div> 
      <span>Wavebox Dev Panel</span>
    </div>
    <div class="actions">
      <a href="/sounds" class="btn">‚Üê Back to Library</a>
      <button class="btn accent" id="refreshBtn">üîÑ Refresh</button>
    </div>
  </header>

  <main>
    <h2>Uploaded Recordings</h2>
    <p style="color:var(--muted)">Review and manage user-submitted audio files. Only admins can access this page.</p>

    {% if uploads %}
      <table>
        <thead>
          <tr>
            <th>User</th>
            <th>File</th>
            <th>Path</th>
            <th>Status</th>
            <th>Preview</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for uid, entry in uploads.items()|sort(reverse=True) %}
          <tr class="{{ entry.status }}">
            <td>
              {% if entry.user %}
                <strong>{{ entry.user.username or entry.user.name }}</strong><br>
                <span class="meta">{{ entry.user.id }}</span>
              {% else %}
                <em>Unknown</em>
              {% endif %}
            </td>

            <td>
              <strong>{{ entry.filename }}</strong><br>
              <span class="meta">{{ entry.timestamp | int | datetime }}</span>
            </td>

            <td>{{ entry.path }}</td>

            <td>
              <span class="badge {{ entry.status }}">{{ entry.status|capitalize }}</span>
              {% if entry.status == 'accepted' and entry.accepted_at %}
                <br><small>{{ entry.accepted_at | int | datetime }}</small>
              {% endif %}
            </td>

            <td>
              <audio controls preload="none">
                <source src="{{ url_for('wavebox.recorded_media', relpath=entry.saved_to) }}" type="audio/mpeg">
              </audio>
            </td>

            <td>
              {% if entry.status == 'pending' %}
                <button class="btn accept" onclick="acceptUpload('{{ uid }}')">‚úÖ Accept</button>
                <button class="btn danger" onclick="rejectUpload('{{ uid }}')">Reject</button>
              {% elif entry.status == 'accepted' %}
                <em>Accepted</em>
              {% else %}
                <em>Rejected</em>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No uploads yet.</p>
    {% endif %}
  </main>

  <footer>
    Wavebox Developer Dashboard ‚Ä¢ {{ uploads|length }} uploads total
  </footer>

  <script>
    // === Reject Upload ===
    async function rejectUpload(id) {
      if (!confirm("Reject this upload?")) return;
      console.log("[Wavebox Dev] Rejecting upload:", id);
      const res = await fetch("/sounds/api/reject", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      const data = await res.json();
      if (data.ok) {
        console.log("‚úÖ Upload rejected:", id);
        alert("Upload rejected.");
        location.reload();
      } else {
        console.error("‚ùå Reject error:", data.error || data);
        alert("Error: " + (data.error || "Unknown error"));
      }
    }

    // === Accept Upload ===
    async function acceptUpload(id) {
      if (!confirm("Accept and finalize this upload? This will lock it in permanently.")) return;
      console.log("[Wavebox Dev] Accepting upload:", id);
      const res = await fetch("/sounds/api/accept", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id })
      });
      const data = await res.json();
      if (data.ok) {
        console.log("‚úÖ Upload accepted:", id, data.entry);
        alert("‚úÖ Upload accepted and locked in!");
        location.reload();
      } else {
        console.error("‚ùå Accept error:", data.error || data);
        alert("Error: " + (data.error || "Unknown error"));
      }
    }

    // === Refresh ===
    document.getElementById("refreshBtn").onclick = () => {
      console.log("[Wavebox Dev] Refreshing page...");
      location.reload();
    };
  </script>
</body>
</html>
